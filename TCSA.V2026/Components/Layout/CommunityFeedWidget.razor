@using TCSA.V2026.Data.DTOs
@using TCSA.V2026.Data.Models
@using TCSA.V2026.Helpers
@using TCSA.V2026.Services
<div class="pa-3">
    <MudText Typo="Typo.body1" Align="Align.Center" Style="font-weight:bold">Community Feed</MudText>
    @if (IsLoading)
    {
        <p>Loading recent feed items...</p>
    }
    else
    {
        @if (RecentFeed.Count > 0)
        {
            @foreach (var item in RecentFeed)
            {
                <MudDivider />
                <div class="py-2 d-flex align-center gap-2">
                    @switch (item.ActivityType)
                    {
                        case ActivityType.ProjectCompleted:
                            <img src="@($"img/icons/{item.ProjectIconUrl}")" alt="Project Icon" style="height:2em;max-width:100%;" />
                            break;
                        case ActivityType.NewBelt:
                            <img src="@($"img/belts/{item.User.Level}-belt.png")" alt="Belt Icon" style="height:1.6em;max-width:100%;" />
                            break;
                        case ActivityType.NewUser:
                            <img src="img/icons/waving-hand.png" alt="Welcome" style="height:2em;max-width:100%;" />
                            break;
                        default:
                            <img src="img/icons/waving-hand.png" alt="Activity" style="height:2em;max-width:100%;" />
                            break;
                    }
                    <div>
                        @switch (item.ActivityType)
                        {
                            case ActivityType.ProjectCompleted:
                                <MudText Typo="Typo.body2">
                                    <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> finished the <strong>@item.ProjectName</strong>
                                </MudText>
                                break;
                            case ActivityType.NewBelt:
                                <MudText Typo="Typo.body2">
                                    <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> earned the <strong>@item.ProjectName</strong> belt!
                                </MudText>
                                break;
                            case ActivityType.NewUser:
                                <MudText Typo="Typo.body2">
                                    Welcome <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> to the community!
                                </MudText>
                                break;
                            default:
                                <MudText Typo="Typo.body2">
                                    <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> did something awesome!
                                </MudText>
                                break;
                        }
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @TimeSpanFormatter.FormatDurationOpen(DateTimeOffset.UtcNow - item.Date)
                        </MudText>
                    </div>
                </div>
            }
        }
        else
        {
            <p>No recent feed items available.</p>
        }
    }
</div>

@code {
    [Inject] private IFeedService FeedService { get; set; } = default!;

    private List<FeedDisplay> RecentFeed { get; set; } = new List<FeedDisplay>();
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        RecentFeed = await FeedService.GetRecentFeedItems();
        IsLoading = false;
    }
}
