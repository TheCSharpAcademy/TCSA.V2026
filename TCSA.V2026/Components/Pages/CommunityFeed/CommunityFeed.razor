@using TCSA.V2026.Data.DTOs
@using TCSA.V2026.Data.Models
@using TCSA.V2026.Data.Models.Responses
@using TCSA.V2026.Helpers
@using TCSA.V2026.Helpers.Constants
@using TCSA.V2026.Services
@page "/feed"

<PageTitle>Community Feed</PageTitle>

<MudContainer>
    <h1 class="mud-primary-text mt-3">Community Feed</h1>
    <p class="mb-4 text-secondary mud-typography-body1">See the latest achievements and project completions across the platform.</p>
    @if (PaginatedFeedItems != null && PaginatedFeedItems.TotalPages > 1)
    {
        <MudBreakpointProvider OnBreakpointChanged="BreakpointChanged">
            <MudPagination Count="PaginatedFeedItems.TotalPages"
            Selected="PageNumber"
            SelectedChanged="OnPageChangedAsync"
            BoundaryCount="_boundaryCount"
            Size="_paginationSize"
            Class="mb-2" />
        </MudBreakpointProvider>
    }
    <MudGrid Spacing="2">
        @if (PaginatedFeedItems != null && PaginatedFeedItems.Items.Count != 0)
        {
            @foreach (var item in PaginatedFeedItems.Items)
            {
                <MudItem Class="d-flex" xs="12" sm="6" lg="4">
                    <MudPaper Class="pa-4 mb-3 d-flex" Elevation="2" Width="100%">
                        <div class="d-flex align-center gap-2">
                            @switch (item.ActivityType)
                            {
                                case ActivityType.ProjectCompleted:
                                    <img src="@($"img/icons/{item.ProjectIconUrl}")" alt="Project Icon" style="height:3em;max-width:100%;" />
                                    break;
                                case ActivityType.NewBelt:
                                    <img src="@($"img/belts/{item.User.Level}-belt.png")" alt="Belt Icon" style="height:3em;max-width:100%;" />
                                    break;
                                case ActivityType.NewUser:
                                    <img src="img/icons/waving-hand.png" alt="Welcome" style="height:3em;max-width:100%;" />
                                    break;
                                default:
                                    <img src="img/icons/waving-hand.png" alt="Activity" style="height:3em;max-width:100%;" />
                                    break;
                            }
                            <div>
                                @switch (item.ActivityType)
                                {
                                    case ActivityType.ProjectCompleted:
                                        <MudText Typo="Typo.body2">
                                            <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> finished the <strong>@item.ProjectName</strong>
                                        </MudText>
                                        break;
                                    case ActivityType.NewBelt:
                                        <MudText Typo="Typo.body2">
                                            <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> earned the <strong>@item.ProjectName</strong> belt!
                                        </MudText>
                                        break;
                                    case ActivityType.NewUser:
                                        <MudText Typo="Typo.body2">
                                            Welcome <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> to the community!
                                        </MudText>
                                        break;
                                    default:
                                        <MudText Typo="Typo.body2">
                                            <strong>@(UserDisplayNameHelper.GetDisplayName(item.User))</strong> did something awesome!
                                        </MudText>
                                        break;
                                }
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @TimeSpanFormatter.FormatDurationOpen(DateTimeOffset.UtcNow - item.Date)
                                </MudText>
                            </div>
                        </div>
                    </MudPaper>
                </MudItem>
            }            
        }
        else
        {
            <MudItem xs="12">
                <div class="text-center my-4">
                    <span>No feed items found.</span>
                </div>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    [Inject] private IFeedService FeedService { get; set; } = default!;

    private PaginatedList<FeedDisplay>? PaginatedFeedItems { get; set; }
    private bool IsLoading = false;
    private int _boundaryCount = 1;
    private Size _paginationSize = Size.Medium;
    private int PageNumber = 1;

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        PaginatedFeedItems = await FeedService.GetPaginatedFeedItems(PageNumber);

        IsLoading = false;
    }

    private async Task OnPageChangedAsync(int newPageNumber)
    {
        PageNumber = newPageNumber;
        PaginatedFeedItems = await FeedService.GetPaginatedFeedItems(PageNumber);
    }

    private void BreakpointChanged(Breakpoint breakpoint)
    {
        if (breakpoint < Breakpoint.Sm)
        {
            _paginationSize = Size.Small;
            _boundaryCount = 1;
        }
        else
        {
            _paginationSize = Size.Medium;
            _boundaryCount = 2;
        }
    }
}
